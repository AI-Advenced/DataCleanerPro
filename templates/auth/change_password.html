{% extends "base.html" %}

{% block title %}Changer le mot de passe - DataCleaner-Pro{% endblock %}

{% block guest_content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lock me-2"></i>Changer le mot de passe
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info border-0 mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Sécurité:</strong> Choisissez un mot de passe fort avec au moins 8 caractères, 
                    incluant lettres majuscules, minuscules, chiffres et caractères spéciaux.
                </div>
                
                <form method="POST" id="changePasswordForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.current_password.label(class="form-label fw-bold") }}
                        <div class="position-relative">
                            {{ form.current_password(class="form-control", id="currentPassword") }}
                            <button type="button" class="btn btn-link position-absolute end-0 top-0 me-2 mt-1" 
                                    onclick="togglePassword('currentPassword', 'toggleIcon1')" id="toggleBtn1">
                                <i class="fas fa-eye" id="toggleIcon1"></i>
                            </button>
                        </div>
                        {% if form.current_password.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.current_password.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.new_password.label(class="form-label fw-bold") }}
                        <div class="position-relative">
                            {{ form.new_password(class="form-control", id="newPassword") }}
                            <button type="button" class="btn btn-link position-absolute end-0 top-0 me-2 mt-1" 
                                    onclick="togglePassword('newPassword', 'toggleIcon2')" id="toggleBtn2">
                                <i class="fas fa-eye" id="toggleIcon2"></i>
                            </button>
                        </div>
                        
                        <!-- Indicateur de force du mot de passe -->
                        <div class="mt-2">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="passwordStrengthText">Force du mot de passe</small>
                        </div>
                        
                        {% if form.new_password.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.new_password.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        {{ form.confirm_password.label(class="form-label fw-bold") }}
                        <div class="position-relative">
                            {{ form.confirm_password(class="form-control", id="confirmPassword") }}
                            <button type="button" class="btn btn-link position-absolute end-0 top-0 me-2 mt-1" 
                                    onclick="togglePassword('confirmPassword', 'toggleIcon3')" id="toggleBtn3">
                                <i class="fas fa-eye" id="toggleIcon3"></i>
                            </button>
                        </div>
                        <div class="mt-1" id="passwordMatchIndicator"></div>
                        
                        {% if form.confirm_password.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.confirm_password.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Exigences du mot de passe -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-shield-alt me-2"></i>Exigences du mot de passe
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="password-requirement" id="req-length">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <span>Au moins 8 caractères</span>
                                    </div>
                                    <div class="password-requirement" id="req-uppercase">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <span>Une majuscule (A-Z)</span>
                                    </div>
                                    <div class="password-requirement" id="req-lowercase">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <span>Une minuscule (a-z)</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="password-requirement" id="req-number">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <span>Un chiffre (0-9)</span>
                                    </div>
                                    <div class="password-requirement" id="req-special">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <span>Un caractère spécial</span>
                                    </div>
                                    <div class="password-requirement" id="req-match">
                                        <i class="fas fa-times text-danger me-2"></i>
                                        <span>Mots de passe identiques</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Retour au profil
                        </a>
                        {{ form.submit(class="btn btn-warning", id="submitBtn") }}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Conseils de sécurité -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Conseils de sécurité
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                <div>
                                    <strong>Utilisez une phrase de passe</strong>
                                    <p class="small text-muted mb-0">
                                        Ex: "MonChat123Mange!" est plus sûr que "M0nCh@t!"
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                <div>
                                    <strong>Évitez les mots courants</strong>
                                    <p class="small text-muted mb-0">
                                        N'utilisez pas votre nom, date de naissance ou mots du dictionnaire
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                <div>
                                    <strong>Mot de passe unique</strong>
                                    <p class="small text-muted mb-0">
                                        N'utilisez jamais ce mot de passe sur d'autres sites
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                <div>
                                    <strong>Gestionnaire de mots de passe</strong>
                                    <p class="small text-muted mb-0">
                                        Utilisez LastPass, 1Password ou Bitwarden
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 p-3 bg-warning bg-opacity-10 rounded">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        <div>
                            <strong>Important:</strong> Après avoir changé votre mot de passe, 
                            vous serez automatiquement déconnecté de tous vos autres appareils.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panneau de droite -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Historique des mots de passe
                </h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0 py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Mot de passe actuel</strong>
                                <br><small class="text-muted">
                                    {% if current_user.last_login %}
                                        Modifié le {{ format_datetime_global(current_user.last_login) }}
                                    {% else %}
                                        Date inconnue
                                    {% endif %}
                                </small>
                            </div>
                            <span class="badge bg-success">Actuel</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Nous conservons l'historique des 5 derniers mots de passe pour éviter 
                        les réutilisations.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Générateur de mot de passe -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-random me-2"></i>Générateur de mot de passe
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Longueur</label>
                    <input type="range" class="form-range" id="passwordLength" min="8" max="50" value="16" 
                           oninput="document.getElementById('lengthValue').textContent = this.value">
                    <div class="d-flex justify-content-between">
                        <small>8</small>
                        <span id="lengthValue">16</span>
                        <small>50</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeUppercase" checked>
                        <label class="form-check-label" for="includeUppercase">
                            Majuscules (A-Z)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeLowercase" checked>
                        <label class="form-check-label" for="includeLowercase">
                            Minuscules (a-z)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeNumbers" checked>
                        <label class="form-check-label" for="includeNumbers">
                            Chiffres (0-9)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeSpecial" checked>
                        <label class="form-check-label" for="includeSpecial">
                            Caractères spéciaux (!@#$...)
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="generatedPassword" readonly 
                               placeholder="Cliquez sur 'Générer'">
                        <button class="btn btn-outline-secondary" type="button" onclick="copyGeneratedPassword()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" onclick="generatePassword()">
                        <i class="fas fa-refresh me-2"></i>Générer
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="useGeneratedPassword()">
                        <i class="fas fa-arrow-right me-2"></i>Utiliser ce mot de passe
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId, iconId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(iconId);
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function calculatePasswordStrength(password) {
    let score = 0;
    
    // Longueur
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    if (password.length >= 16) score += 1;
    
    // Complexité
    if (/[a-z]/.test(password)) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^A-Za-z0-9]/.test(password)) score += 1;
    
    const strengths = [
        { score: 0, text: 'Très faible', class: 'bg-danger', textClass: 'text-danger', percentage: 15 },
        { score: 1, text: 'Faible', class: 'bg-danger', textClass: 'text-danger', percentage: 25 },
        { score: 2, text: 'Faible', class: 'bg-warning', textClass: 'text-warning', percentage: 40 },
        { score: 3, text: 'Moyen', class: 'bg-warning', textClass: 'text-warning', percentage: 60 },
        { score: 4, text: 'Fort', class: 'bg-info', textClass: 'text-info', percentage: 80 },
        { score: 5, text: 'Très fort', class: 'bg-success', textClass: 'text-success', percentage: 90 },
        { score: 6, text: 'Excellent', class: 'bg-success', textClass: 'text-success', percentage: 100 },
        { score: 7, text: 'Excellent', class: 'bg-success', textClass: 'text-success', percentage: 100 }
    ];
    
    return strengths[Math.min(score, 7)];
}

function updatePasswordRequirements(password) {
    const requirements = {
        'req-length': password.length >= 8,
        'req-uppercase': /[A-Z]/.test(password),
        'req-lowercase': /[a-z]/.test(password),
        'req-number': /[0-9]/.test(password),
        'req-special': /[^A-Za-z0-9]/.test(password)
    };
    
    Object.keys(requirements).forEach(reqId => {
        const element = document.getElementById(reqId);
        const icon = element.querySelector('i');
        const met = requirements[reqId];
        
        if (met) {
            icon.className = 'fas fa-check text-success me-2';
            element.style.opacity = '1';
        } else {
            icon.className = 'fas fa-times text-danger me-2';
            element.style.opacity = '0.6';
        }
    });
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const indicator = document.getElementById('passwordMatchIndicator');
    const matchReq = document.getElementById('req-match');
    
    if (confirmPassword.length > 0) {
        if (newPassword === confirmPassword && newPassword.length >= 8) {
            indicator.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>Les mots de passe correspondent</small>';
            
            if (matchReq) {
                const icon = matchReq.querySelector('i');
                icon.className = 'fas fa-check text-success me-2';
                matchReq.style.opacity = '1';
            }
        } else {
            indicator.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>Les mots de passe ne correspondent pas</small>';
            
            if (matchReq) {
                const icon = matchReq.querySelector('i');
                icon.className = 'fas fa-times text-danger me-2';
                matchReq.style.opacity = '0.6';
            }
        }
    } else {
        indicator.innerHTML = '';
        
        if (matchReq) {
            const icon = matchReq.querySelector('i');
            icon.className = 'fas fa-times text-danger me-2';
            matchReq.style.opacity = '0.6';
        }
    }
}

function generatePassword() {
    const length = parseInt(document.getElementById('passwordLength').value);
    const includeUppercase = document.getElementById('includeUppercase').checked;
    const includeLowercase = document.getElementById('includeLowercase').checked;
    const includeNumbers = document.getElementById('includeNumbers').checked;
    const includeSpecial = document.getElementById('includeSpecial').checked;
    
    let charset = '';
    if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
    if (includeNumbers) charset += '0123456789';
    if (includeSpecial) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';
    
    if (charset === '') {
        alert('Veuillez sélectionner au moins un type de caractère');
        return;
    }
    
    let password = '';
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    document.getElementById('generatedPassword').value = password;
}

function copyGeneratedPassword() {
    const input = document.getElementById('generatedPassword');
    if (input.value) {
        input.select();
        navigator.clipboard.writeText(input.value).then(() => {
            const btn = event.target.closest('button');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.replace('btn-outline-secondary', 'btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.replace('btn-success', 'btn-outline-secondary');
            }, 2000);
        });
    }
}

function useGeneratedPassword() {
    const generatedPassword = document.getElementById('generatedPassword').value;
    if (generatedPassword) {
        document.getElementById('newPassword').value = generatedPassword;
        document.getElementById('confirmPassword').value = generatedPassword;
        
        // Déclencher les validations
        document.getElementById('newPassword').dispatchEvent(new Event('input'));
        document.getElementById('confirmPassword').dispatchEvent(new Event('input'));
        
        const btn = event.target;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Utilisé !';
        btn.classList.replace('btn-outline-success', 'btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.classList.replace('btn-success', 'btn-outline-success');
        }, 2000);
    }
}

// Initialisation des événements
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordField = document.getElementById('newPassword');
    const confirmPasswordField = document.getElementById('confirmPassword');
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');
    
    // Validation en temps réel du nouveau mot de passe
    newPasswordField.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        
        strengthBar.style.width = strength.percentage + '%';
        strengthBar.className = 'progress-bar ' + strength.class;
        strengthText.textContent = strength.text;
        strengthText.className = 'text-muted ' + strength.textClass;
        
        updatePasswordRequirements(password);
        
        // Validation du champ
        if (password.length >= 8 && strength.score >= 4) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else if (password.length > 0) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else {
            this.classList.remove('is-invalid', 'is-valid');
        }
        
        // Vérifier la correspondance si confirmPassword a une valeur
        if (confirmPasswordField.value) {
            checkPasswordMatch();
        }
    });
    
    // Validation de la correspondance des mots de passe
    confirmPasswordField.addEventListener('input', checkPasswordMatch);
    
    // Validation du formulaire
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!currentPassword) {
            e.preventDefault();
            alert('Veuillez saisir votre mot de passe actuel');
            return;
        }
        
        if (newPassword.length < 8) {
            e.preventDefault();
            alert('Le nouveau mot de passe doit contenir au moins 8 caractères');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('Les nouveaux mots de passe ne correspondent pas');
            return;
        }
        
        if (currentPassword === newPassword) {
            e.preventDefault();
            alert('Le nouveau mot de passe doit être différent de l\'ancien');
            return;
        }
        
        // Animation du bouton de soumission
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<span class="loading-spinner me-2"></span>Modification...';
        submitBtn.disabled = true;
    });
    
    // Animation des cartes
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

<style>
.progress-bar {
    transition: width 0.3s ease, background-color 0.3s ease;
}

.password-requirement {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    transition: opacity 0.3s ease;
}

.form-range::-webkit-slider-thumb {
    background: #3498db;
}

.form-range::-moz-range-thumb {
    background: #3498db;
    border: none;
}

@media (max-width: 768px) {
    .password-requirement {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}